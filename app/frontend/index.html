<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Task List</title>
  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
    body { margin: 0; background: #f6f7f9; }
    .container { max-width: 720px; margin: 40px auto; background: #fff; padding: 24px; border-radius: 16px; box-shadow: 0 10px 30px rgba(0,0,0,.06); }
    h1 { margin: 0 0 16px; font-size: 24px; }
    form { display: flex; gap: 8px; margin-bottom: 16px; }
    input[type="text"] { flex: 1; padding: 10px 12px; border: 1px solid #d0d7de; border-radius: 10px; }
    button { padding: 10px 14px; border: 1px solid #1f6feb; background: #1f6feb; color: #fff; border-radius: 10px; cursor: pointer; }
    button:disabled { opacity: .6; cursor: not-allowed; }
    ul { list-style: none; padding: 0; margin: 0; }
    li { display: flex; align-items: center; gap: 10px; padding: 10px 8px; border-bottom: 1px solid #eef1f4; }
    li:last-child { border-bottom: none; }
    .title { flex: 1; }
    .title.done { text-decoration: line-through; color: #6b7280; }
    .delete { background: #ef4444; border-color: #ef4444; }
    .muted { color: #6b7280; font-size: 12px; margin-top: 4px; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Tasks</h1>
    <form id="add-form">
      <input id="task-input" type="text" placeholder="Add a taskâ€¦" required />
      <button id="add-btn" type="submit">Add</button>
    </form>
    <ul id="list"></ul>
    <div class="muted">API base: <code id="api-base-label"></code></div>
  </div>

  <script>
    const API_BASE = localStorage.getItem('API_BASE') || '/api';
    document.getElementById('api-base-label').textContent = API_BASE;

    document.getElementById('api-base-label').addEventListener('click', () => {
      const next = prompt('API base URL', API_BASE);
      if (next) { localStorage.setItem('API_BASE', next); location.reload(); }
    });

    const listEl = document.getElementById('list');
    const formEl = document.getElementById('add-form');
    const inputEl = document.getElementById('task-input');

    const nextId = () => Date.now();

    const liTemplate = (task) => {
      const li = document.createElement('li');

      const checkbox = document.createElement('input');
      checkbox.type = 'checkbox';
      checkbox.checked = !!task.completed;
      checkbox.addEventListener('change', () => toggleTask(task));

      const span = document.createElement('span');
      span.className = 'title' + (task.completed ? ' done' : '');
      span.textContent = task.title;

      const del = document.createElement('button');
      del.className = 'delete';
      del.textContent = 'Delete';
      del.addEventListener('click', () => removeTask(task.id));

      li.appendChild(checkbox);
      li.appendChild(span);
      li.appendChild(del);
      li.dataset.id = task.id;
      return li;
    };

    async function fetchJSON(url, opts) {
      const res = await fetch(url, { headers: { 'Content-Type': 'application/json' }, ...opts });
      if (!res.ok) throw new Error(await res.text());
      return res.json();
    }

    async function loadTasks() {
      listEl.innerHTML = '';
      try {
        const tasks = await fetchJSON(`${API_BASE}/tasks`);
        tasks.forEach(t => listEl.appendChild(liTemplate(t)));
      } catch (e) {
        listEl.innerHTML = `<li>Failed to load tasks. ${e}</li>`;
      }
    }

    async function addTask(title) {
      const task = { id: nextId(), title, completed: false };
      const created = await fetchJSON(`${API_BASE}/tasks`, { method: 'POST', body: JSON.stringify(task) });
      listEl.appendChild(liTemplate(created));
    }

    async function toggleTask(task) {
      const updated = { id: task.id, title: task.title, completed: !task.completed };
      await fetchJSON(`${API_BASE}/tasks/${task.id}`, { method: 'PATCH', body: JSON.stringify(updated) });
      await loadTasks();
    }

    async function removeTask(id) {
      await fetch(`${API_BASE}/tasks/${id}`, { method: 'DELETE' });
      const el = listEl.querySelector(`li[data-id="${id}"]`);
      if (el) el.remove();
    }

    formEl.addEventListener('submit', async (e) => {
      e.preventDefault();
      const title = inputEl.value.trim();
      if (!title) return;
      formEl.querySelector('button').disabled = true;
      try {
        await addTask(title);
        inputEl.value = '';
      } catch (e) {
        alert('Failed to add task: ' + e);
      } finally {
        formEl.querySelector('button').disabled = false;
      }
    });

    loadTasks();
  </script>
</body>
</html>
